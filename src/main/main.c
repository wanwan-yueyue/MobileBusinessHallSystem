/*
 * 文件名称：main.c
 * 文件路径：.\MobileBusinessHallSystem\main.c
 * 功能描述：程序主入口模块 - 负责系统启动、初始化和主循环控制
 *          协调各个模块的初始化和运行，提供程序的生命周期管理
 * 作    者：
 * 创建日期：2025-10-29
 * 版本信息：v2.1（适配全局变量管理）
 * 版权声明：© 2025 | 保留所有权利
 * 
 * 实现说明：
 * 1. 设置控制台编码为UTF-8，支持中文显示
 * 2. 协调系统各个模块的初始化顺序
 * 3. 管理程序的主循环和退出流程
 * 4. 确保资源的正确初始化和清理
 * 
 * 依赖说明：
 * - 标准库：stdio.h、time.h、stdlib.h、windows.h、conio.h
 * - 自定义模块：menu.h、data.h、utils.h、global.h
 * 
 * 修改记录：
 * 2025-10-29  新增文件，实现基础程序框架（v1.0）
 * 2025-10-30  优化初始化流程，增加错误处理（v1.1）
 * 2025-10-30  完善控制台设置和用户交互（v1.2）
 * 2025-11-1   适配全局变量管理，优化资源清理（v2.0）
 * 2025-11-4   完善注释和代码结构（v2.1）
 */

#include "menu.h"
#include "data.h"
#include "utils.h"
#include "global.h"
#include <stdio.h>
#include <time.h>
#include <stdlib.h>
#include <windows.h>
#include <conio.h>

// ========== 系统配置函数 ==========

/**
 * @brief 设置控制台编码为UTF-8
 * @retval 无
 * 
 * 功能说明：
 * 1. 设置控制台输出编码为UTF-8，支持中文显示
 * 2. 设置控制台输入编码为UTF-8，确保输入兼容
 * 3. 为系统的多语言支持提供基础环境
 * 
 * 实现细节：
 * - 使用Windows API设置控制台代码页
 * - 同时设置输入和输出编码确保一致性
 * - 在程序启动时最早调用，确保后续输出正确
 * 
 * 注意事项：
 * - 必须在任何输出操作前调用
 * - 仅适用于Windows平台
 * - 对于其他平台需要相应调整
 */
void setConsoleEncoding() {
    // 设置控制台输出编码为UTF-8
    SetConsoleOutputCP(CP_UTF8);
    SetConsoleCP(CP_UTF8);
}

// ========== 程序主入口函数 ==========

/**
 * @brief 程序主入口函数
 * @retval int 程序退出状态码
 * 
 * 功能说明：
 * 1. 设置控制台环境配置
 * 2. 显示系统启动画面和欢迎信息
 * 3. 初始化系统各个模块和数据结构
 * 4. 加载持久化数据到内存
 * 5. 进入主菜单循环处理用户交互
 * 6. 程序退出前执行资源清理
 * 
 * 实现流程：
 * - 设置控制台编码支持中文显示
 * - 显示系统标题和启动动画
 * - 执行系统初始化和数据加载
 * - 进入无限循环的主菜单界面
 * - 在程序退出时清理所有资源
 * 
 * 异常处理：
 * - 系统初始化失败时退出程序
 * - 数据加载失败时使用默认配置
 * - 确保在任何情况下都能正确清理资源
 * 
 * 注意事项：
 * - 必须确保资源在退出前被正确释放
 * - 主循环是无限循环，通过退出选项终止
 * - 返回0表示正常退出，非0表示异常退出
 */
int main() {
    // 设置控制台编码
    setConsoleEncoding();

    // 显示系统启动画面
    showTitle();

    // 系统初始化
    printSectionTitle("系统初始化");
    printLeft("正在初始化系统组件...");
    initSystem();                                           // 初始化系统数据结构
    loadData();                                             // 加载用户数据和手机号资源
    
    printSuccess("系统初始化完成！");
    printLeft("欢迎使用移动营业厅管理系统！");
    
    printf(YELLOW "\n    按任意键继续..." RESET);
    _getch();

    // 进入主菜单循环
    showMainMenu();

    // 程序退出前的清理
    cleanupGlobalResources();

    return 0;
}